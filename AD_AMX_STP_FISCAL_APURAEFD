CREATE OR REPLACE PROCEDURE "AD_AMX_STP_FISCAL_APURAEFD" (
       P_CODUSU NUMBER,        -- Código do usuário logado
       P_IDSESSAO VARCHAR2,    -- Identificador da execução. Serve para buscar informações dos parâmetros/campos da execução.
       P_QTDLINHAS NUMBER,     -- Informa a quantidade de registros selecionados no momento da execução.
       P_MENSAGEM OUT VARCHAR2 -- Caso seja passada uma mensagem aqui, ela será exibida como uma informação ao usuário.
) AS
       FIELD_NUNICO NUMBER;
       V_CODEMP INT;
       V_DATAINI DATE;
       V_DATAFIN DATE;
       V_NUNICO INT;
       V_CODEMPMATRIZ INT;
BEGIN






       FOR I IN 1..P_QTDLINHAS 
       LOOP                  

           FIELD_NUNICO := ACT_INT_FIELD(P_IDSESSAO, I, 'NUNICO');

           FOR FILIAL IN (select  
emp.CODEMP,
emp.CODEMPMATRIZ, 
efd.referencia,
rank() over (order by EMP.CODEMP ) SEQ,
EFD.NUNICO
from tsiemp emp, ad_matrizefd efd
where 
emp.codempmatriz = efd.codemp
AND EFD.NUNICO = FIELD_NUNICO) loop

INSERT INTO AD_APURACAOEFD (NUNICO, SEQ, CODEMP) 
VALUES (FILIAL.NUNICO, FILIAL.SEQ,  FILIAL.CODEMP);




end loop;

UPDATE AD_MATRIZEFD SET APURADO = 'S', CODUSU  =STP_GET_CODUSULOGADO WHERE NUNICO = FIELD_NUNICO;

                    SELECT
                    DATAINI
                    ,DATAFIN
                    INTO V_DATAINI, V_DATAFIN
                    FROM AD_PERIODOS
                    WHERE DATAINI = (SELECT REFERENCIA FROM AD_MATRIZEFD WHERE NUNICO = FIELD_NUNICO);


         FOR EMPRESAS IN (  SELECT 
           CODEMP,
           NUNICO,
           SEQ


           FROM AD_APURACAOEFD
           WHERE NUNICO = FIELD_NUNICO) LOOP


FOR APURA IN (
SELECT
EFD.SEQ AS SEQ,
ROWNUM AS SEQUENCIA,
CASE WHEN CODINC = 0 THEN 
ITE.USOPROD 
WHEN CODINC = 3 THEN 
'F' END AS USOPROD,
ITE.CODPROD, 
ITE.QTDNEG, 
CASE WHEN CODINC = 0 THEN
ITE.VLRUNIT 
WHEN CODINC = 3 THEN 
DIN.BASE
END AS VLRUNIT,
ITE.NUNOTA,
CAB.NUMNOTA,
ITE.CODLOCALORIG,
ITE.CONTROLE,
ITE.CODCFO,
CASE WHEN CODINC = 0 THEN 
ITE.VLRTOT
WHEN CODINC = 3 THEN 
CAB.VLRFRETE
END AS VLRTOT,
CASE WHEN CODINC = 0 THEN 
ITE.VLRICMS
WHEN CODINC = 3 THEN 
CAB.ICMSFRETE
END AS VLRICMS,
CASE WHEN CODINC = 0 THEN
ITE.VLRDESC
WHEN CODINC = 3 THEN
0
END VLRDESC,
CAB.CODTIPOPER,
PRO.GRUPOCOFINS,
PRO.GRUPOPIS, 
DIN.BASE, 
DIN.BASERED,
DIN.ALIQUOTA,
DIN.VALOR, 
DIN.CST,
DIN.CODINC, 
DIN.CODIMP,
DIN.SEQUENCIA AS SEQUENCIAITE,
CAB.CODPARC,
CAB.DTENTSAI,
CAB.TIPMOV
FROM 
TGFITE ITE    INNER JOIN TGFCAB CAB 
                ON CAB.NUNOTA = ITE.NUNOTA
                AND CAB.CODEMP = ITE.CODEMP
                INNER JOIN TGFTOP TOP
                ON TOP.CODTIPOPER = CAB.CODTIPOPER
                AND TOP.DHALTER = CAB.DHTIPOPER
                INNER JOIN TGFPRO PRO ON 
                ITE.CODPROD = PRO.CODPROD
                INNER JOIN TGFDIN DIN
                ON DIN.NUNOTA = ITE.NUNOTA
                AND DIN.SEQUENCIA = ITE.SEQUENCIA
                AND DIN.CODIMP IN (6,7)
                LEFT JOIN AD_APURACAOEFD EFD ON EFD.CODEMP = ITE.CODEMP 
                                             AND EFD.NUNICO = FIELD_NUNICO
                WHERE CAB.CODEMP = EMPRESAS.CODEMP
                AND CAB.DTENTSAI >= V_DATAINI
                AND CAB.DTENTSAI <= V_DATAFIN
                AND CAB.TIPMOV IN ('C','E','V','D')


)
LOOP

INSERT INTO AD_ITEAPURACAOEFD
(NUNICO,
                SEQ,
                SEQUENCIAITE,
                CODPROD,
                QTDNEG,
                VLRUNIT,
                NUNOTA,
                NUMNOTA, 
                CODLOCALORIG,
                CONTROLE,
                CODCFO,
                VLRTOT,
                VLRICMS, 
                CODTIPOPER,
                GRUPOCOFINS,
                GRUPOPIS,
                BASE,
                BASERED,
                ALIQUOTA,
                CST, 
                CODINC,
                CODIMP,
                SEQUENCIA,
                CODPARC,
                DTENTSAI,
                VALOR,
                VLRDESC,
                TIPMOV,
                ALTERADO,
                ALTERADOCAB,
                ALTERADOCTB,
                TIPO
                )
VALUES (FIELD_NUNICO, 
        APURA.SEQ,
        APURA.SEQUENCIAITE,
        APURA.CODPROD,
        APURA.QTDNEG,
        APURA.VLRUNIT,
        APURA.NUNOTA,
        APURA.NUMNOTA,
        APURA.CODLOCALORIG,
        APURA.CONTROLE,
        APURA.CODCFO,
        APURA.VLRTOT,
        APURA.VLRICMS,
        APURA.CODTIPOPER,
        APURA.GRUPOCOFINS,
        APURA.GRUPOPIS,
        APURA.BASE,
        APURA.BASERED,
        APURA.ALIQUOTA,
        APURA.CST,
        APURA.CODINC,
        APURA.CODIMP,
        APURA.SEQUENCIA,
        APURA.CODPARC,
        APURA.DTENTSAI,
        APURA.VALOR,
        APURA.VLRDESC,
        APURA.TIPMOV,
        0,
        0,
        0,
        APURA.USOPROD


);


       END LOOP;
      END LOOP;



FOR EMP_CONS IN( SELECT 
           CODEMP,
           NUNICO,
           SEQ


           FROM AD_APURACAOEFD
           WHERE NUNICO = FIELD_NUNICO)LOOP





FOR CONS IN (select CODCFO,CODINC,CST,BASEPIS,BASEREDPIS,VALORPIS,BASECOFINS,BASEREDCOFINS,VALORCOFINS,SEQ ,NUNICO,CODEMP,SEQUENCIA from(
select 
EFD.CODCFO,
EFD.NUNICO,
APR.CODEMP,
EFD.CODINC,
EFD.CST,
EFD.SEQ,
(SELECT sum(BASE) FROM AD_ITEAPURACAOEFD A WHERE A.NUNICO = EFD.NUNICO AND A.CODIMP = 6 AND A.CODCFO = EFD.CODCFO AND A.CODINC = EFD.CODINC AND A.CST = EFD.CST AND A.SEQ = EFD.SEQ ) AS BASEPIS,
(SELECT sum(BASERED) FROM AD_ITEAPURACAOEFD A WHERE A.NUNICO = EFD.NUNICO AND A.CODIMP = 6 AND A.CODCFO = EFD.CODCFO AND A.CODINC = EFD.CODINC AND A.CST = EFD.CST AND A.SEQ = EFD.SEQ ) AS BASEREDPIS,
(SELECT sum(VALOR) FROM AD_ITEAPURACAOEFD A WHERE A.NUNICO = EFD.NUNICO AND A.CODIMP = 6 AND A.CODCFO = EFD.CODCFO AND A.CODINC = EFD.CODINC AND A.CST = EFD.CST AND A.SEQ = EFD.SEQ ) AS VALORPIS, 
(SELECT sum(BASE) FROM AD_ITEAPURACAOEFD A WHERE A.NUNICO = EFD.NUNICO AND A.CODIMP = 7 AND A.CODCFO = EFD.CODCFO AND A.CODINC = EFD.CODINC AND A.CST = EFD.CST AND A.SEQ = EFD.SEQ) AS BASECOFINS,
(SELECT sum(BASERED) FROM AD_ITEAPURACAOEFD A WHERE A.NUNICO = EFD.NUNICO AND A.CODIMP = 7 AND A.CODCFO = EFD.CODCFO AND A.CODINC = EFD.CODINC AND A.CST = EFD.CST AND A.SEQ = EFD.SEQ ) AS BASEREDCOFINS,
(SELECT sum(VALOR) FROM AD_ITEAPURACAOEFD A WHERE A.NUNICO = EFD.NUNICO AND A.CODIMP = 7 AND A.CODCFO = EFD.CODCFO AND A.CODINC = EFD.CODINC AND A.CST = EFD.CST AND A.SEQ = EFD.SEQ ) AS VALORCOFINS,
rank() over (order by CODCFO, CST,CODINC,EFD.SEQ, EFD.CST) SEQUENCIA





from AD_ITEAPURACAOEFD EFD, AD_APURACAOEFD APR
WHERE APR.NUNICO = FIELD_NUNICO
AND EFD.SEQ = APR.SEQ
AND APR.CODEMP = EMP_CONS.CODEMP
and apr.nunico = efd.nunico
AND APR.SEQ = EMP_CONS.SEQ
group by 
EFD.CODCFO,
EFD.CODINC,
EFD.nunico,
EFD.SEQ,
EFD.CST, APR.CODEMP)WHERE VALORPIS >0 OR VALORCOFINS>0)LOOP



insert into AD_CONAPURACAOEFD
(SEQ,
NUNICO, 
SEQUENCIA,
CODEMP,
CODCFO,
CST,
BASEPIS,
BASEREDPIS,
VALORPIS, 
BASECOFINS, 
BASEREDCOFINS, 
VALORCOFINS)values (CONS.SEQ,
CONS.NUNICO, 
CONS.SEQUENCIA,
CONS.CODEMP,
CONS.CODCFO,
CONS.CST,
CONS.BASEPIS, 
CONS.BASEREDPIS, 
CONS.VALORPIS, 
CONS.BASECOFINS, 
CONS.BASEREDCOFINS, 
CONS.VALORCOFINS);


END LOOP;
END LOOP;
COMMIT;


FOR CONS_EMPRESA IN (SELECT * FROM (select 
CODEMP,
CODCFO, 
NUNICO,
SUM(BASEREDPIS) BASEREDPIS,
SUM(BASEREDCOFINS) BASEREDCOFINS,
SUM(BASEPIS) BASEPIS,
SUM(BASECOFINS) BASECOFINS,
SUM(VALORPIS) VALORPIS,
SUM(VALORCOFINS) VALORCOFINS,
rank() over (order by CODCFO,CODEMP) SEQUENCIA

from AD_CONAPURACAOEFD
WHERE NUNICO = FIELD_NUNICO
GROUP BY 
CODEMP,
CODCFO,
NUNICO)WHERE VALORPIS >0 OR VALORCOFINS >0)
LOOP

insert into AD_CONAPURACAOEFDEMP
(SEQUENCIA,
NUNICO, 
CODEMP,
CODCFO,
BASEPIS,
BASEREDPIS,
VALORPIS, 
BASECOFINS, 
BASEREDCOFINS, 
VALORCOFINS)values (CONS_EMPRESA.SEQUENCIA,
CONS_EMPRESA.NUNICO, 
CONS_EMPRESA.CODEMP,
CONS_EMPRESA.CODCFO,
CONS_EMPRESA.BASEPIS, 
CONS_EMPRESA.BASEREDPIS, 
CONS_EMPRESA.VALORPIS, 
CONS_EMPRESA.BASECOFINS, 
CONS_EMPRESA.BASEREDCOFINS, 
CONS_EMPRESA.VALORCOFINS);

END LOOP;
COMMIT;

FOR CONS_GERAL IN (SELECT * FROM (select 
CODCFO, 
NUNICO,
SUM(BASEREDPIS) BASEREDPIS,
SUM(BASEREDCOFINS) BASEREDCOFINS,
SUM(BASEPIS) BASEPIS,
SUM(BASECOFINS) BASECOFINS,
SUM(VALORPIS) VALORPIS,
SUM(VALORCOFINS) VALORCOFINS,
rank() over (order by CODCFO) SEQUENCIA

from AD_CONAPURACAOEFD
WHERE NUNICO = FIELD_NUNICO
GROUP BY 
CODCFO,
NUNICO)WHERE VALORPIS >0 OR VALORCOFINS >0) LOOP

insert into AD_CONAPURACAOEFDMATRIZ
(SEQUENCIA,
NUNICO, 
CODCFO,
BASEPIS,
BASEREDPIS,
VALORPIS, 
BASECOFINS, 
BASEREDCOFINS, 
VALORCOFINS)values (CONS_GERAL.SEQUENCIA,
CONS_GERAL.NUNICO, 
CONS_GERAL.CODCFO,
CONS_GERAL.BASEPIS, 
CONS_GERAL.BASEREDPIS, 
CONS_GERAL.VALORPIS, 
CONS_GERAL.BASECOFINS, 
CONS_GERAL.BASEREDCOFINS, 
CONS_GERAL.VALORCOFINS);





END LOOP;




end loop;



 P_MENSAGEM := 'Apuração realizada com sucesso !!';



END;
/
