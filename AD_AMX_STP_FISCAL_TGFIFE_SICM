CREATE OR REPLACE PROCEDURE "AD_AMX_STP_FISCAL_TGFIFE_SICM" (
       P_CODUSU NUMBER,        -- Código do usuário logado
       P_IDSESSAO VARCHAR2,    -- Identificador da execução. Serve para buscar informações dos parâmetros/campos da execução.
       P_QTDLINHAS NUMBER,     -- Informa a quantidade de registros selecionados no momento da execução.
       P_MENSAGEM OUT VARCHAR2 -- Caso seja passada uma mensagem aqui, ela será exibida como uma informação ao usuário.
) AS
       FIELD_NUNICO NUMBER;
       FIELD_SEQ NUMBER;
       FIELD_SEQUENCIA NUMBER;
       V_REDBASEPISEMP NUMBER; 
V_ALIQPISEMP NUMBER;
V_CSTPISEMP NUMBER;
V_EMPPIS INT;
V_EMPCOFINS INT;
V_TRIBUTAPISEMP INT;
V_TOPPIS INT;
V_TOPCOFINS INT;
V_TRIBUTACOFINSEMP INT;
V_TRIBUTA INT;
V_REDBASEPIS NUMBER;
V_ALIQPIS NUMBER;
V_CSTPIS NUMBER;
V_NUNICO INT;
V_SEQ INT;
V_PREDBASECOFINSEMP NUMBER; 
V_ALIQCOFINSEMP NUMBER;
V_CSTCOFINSEMP NUMBER;

V_REDBASECOFINS NUMBER;
V_ALIQCOFINS NUMBER;
V_CSTCOFINS NUMBER;


BEGIN



       FOR I IN 1..P_QTDLINHAS 
       LOOP                  

           FIELD_NUNICO := ACT_INT_FIELD(P_IDSESSAO, I, 'NUNICO');
           FIELD_SEQ := ACT_INT_FIELD(P_IDSESSAO, I, 'SEQ');
           FIELD_SEQUENCIA := ACT_INT_FIELD(P_IDSESSAO, I, 'SEQUENCIA');

V_NUNICO := FIELD_NUNICO;
V_SEQ :=FIELD_SEQ;
--VALIDA REGRAS PIS
FOR PIS IN (
SELECT
I.CODPARC,
I.CODTIPOPER,
I.GRUPOPIS,
I.GRUPOCOFINS,
I.SEQUENCIA,
I.CODPROD,
I.NUNOTA,
I.CODINC,
I.CODIMP,
I.VLRTOT,
I.VLRICMS,
NVL(I.VLRDESC,0) AS VLRDESC,
I.BASE, 
I.BASERED,
I.ALIQUOTA,
I.CST,
I.VALOR,
A.CODEMP,
I.NUNICO,
I.SEQ,
CASE WHEN 
I.CODCFO <5000 THEN 'E'
WHEN I.CODCFO>5000 THEN 'S'
END AS ENTSAI



FROM AD_ITEAPURACAOEFD I, AD_APURACAOEFD A
WHERE I.NUNICO = A.NUNICO
AND A.SEQ = I.SEQ
AND I.NUNICO = FIELD_NUNICO
AND I.SEQ IN FIELD_SEQ
AND I.SEQUENCIA IN FIELD_SEQUENCIA
AND I.CODIMP = 6 )LOOP

--Prioridade 1 das Alíquotas -TOP, Empresa, GRUPO.


SELECT 
NVL(COUNT(*),0)
INTO V_EMPPIS

FROM TGFIFE
WHERE NOMEIMP = 'PIS'
AND CODTIPOPER = PIS.CODTIPOPER
AND GRUPOIMP = PIS.GRUPOPIS
AND CODEMP = PIS.CODEMP
AND ENTSAI = PIS.ENTSAI
AND CODPARC = 0;


IF V_EMPPIS >=1 THEN


SELECT 
CASE WHEN REDBASE = 0 THEN 1
ELSE REDBASE/100 END AS REDBASE,

nvl(ALIQ,0), 
nvl(CST,0),
CASE WHEN ALIQ = 0 THEN 0
ELSE 1 END AS TRIBUTA
INTO V_REDBASEPISEMP,
V_ALIQPISEMP,
V_CSTPISEMP,
V_TRIBUTAPISEMP


FROM TGFIFE
WHERE NOMEIMP = 'PIS'
AND CODTIPOPER = PIS.CODTIPOPER
AND GRUPOIMP = PIS.GRUPOPIS
AND CODEMP = PIS.CODEMP
AND ENTSAI = PIS.ENTSAI
AND CODPARC = 0;


UPDATE AD_ITEAPURACAOEFD SET ALTERADO =1, BASE = ROUND((PIS.VLRTOT-PIS.VLRDESC),2)*V_TRIBUTAPISEMP, BASERED = ROUND((((PIS.VLRTOT-PIS.VLRDESC))*V_REDBASEPISEMP),2)*V_TRIBUTAPISEMP, ALIQUOTA = V_ALIQPISEMP, CST = V_CSTPISEMP, VALOR = ROUND((((((PIS.VLRTOT-PIS.VLRDESC))*V_REDBASEPISEMP)*V_ALIQPISEMP)/100),2) 
WHERE NUNICO = PIS.NUNICO
AND SEQ = PIS.SEQ
AND SEQUENCIA = PIS.SEQUENCIA
AND CODPROD = PIS.CODPROD
AND NUNOTA = PIS.NUNOTA
AND CODIMP = 6;
END IF;
---PRIORIDADE 2 TOP, GRUPO

IF V_EMPPIS <=0 THEN



SELECT 
NVL(COUNT(*),0)
INTO V_TOPPIS

FROM TGFIFE
WHERE NOMEIMP = 'PIS'
AND CODTIPOPER = PIS.CODTIPOPER
AND GRUPOIMP = PIS.GRUPOPIS
AND ENTSAI = PIS.ENTSAI
AND CODEMP = 0
AND CODPARC = 0;

IF V_TOPPIS >=1 THEN 


SELECT 
CASE WHEN REDBASE = 0 THEN 1
ELSE REDBASE/100 END AS REDBASE,
nvl(ALIQ,0), 
nvl(CST,0),
CASE WHEN ALIQ = 0 THEN 0
ELSE 1 END AS TRIBUTA
INTO V_REDBASEPIS,
V_ALIQPIS,
V_CSTPIS,
V_TRIBUTA



FROM TGFIFE
WHERE NOMEIMP = 'PIS'
AND CODTIPOPER = PIS.CODTIPOPER
AND GRUPOIMP = PIS.GRUPOPIS
AND ENTSAI = PIS.ENTSAI
AND CODPARC =0;




UPDATE AD_ITEAPURACAOEFD SET ALTERADO =1, BASE = ROUND((PIS.VLRTOT-PIS.VLRDESC),2)*V_TRIBUTA, BASERED = ROUND((((PIS.VLRTOT-PIS.VLRDESC))*V_REDBASEPIS),2)*V_TRIBUTA, ALIQUOTA = V_ALIQPIS, CST = V_CSTPIS, VALOR = ROUND((((((PIS.VLRTOT-PIS.VLRDESC))*V_REDBASEPIS)*V_ALIQPIS)/100),2)
WHERE NUNICO = PIS.NUNICO
AND SEQ = PIS.SEQ
AND SEQUENCIA = PIS.SEQUENCIA
AND CODPROD = PIS.CODPROD
AND NUNOTA = PIS.NUNOTA
AND CODIMP = 6;

END IF;
END IF;


--Prioridade 3 das Alíquotas - GRUPO.

IF V_EMPPIS <=0 AND V_TOPPIS <=0 THEN 
SELECT 
CASE WHEN REDBASE = 0 THEN 1
ELSE REDBASE/100 END AS REDBASE,
nvl(ALIQ,0), 
nvl(CST,0),
CASE WHEN ALIQ = 0 THEN 0
ELSE 1 END AS TRIBUTA
INTO V_REDBASEPIS,
V_ALIQPIS,
V_CSTPIS,
V_TRIBUTA



FROM TGFIFE
WHERE NOMEIMP = 'PIS'
AND GRUPOIMP = PIS.GRUPOPIS
AND ENTSAI = PIS.ENTSAI
AND CODPARC =0
AND CODTIPOPER = 0
AND CODEMP = 0;


UPDATE AD_ITEAPURACAOEFD SET ALTERADO =1, BASE = ROUND((PIS.VLRTOT-PIS.VLRDESC),2)*V_TRIBUTA, BASERED = ROUND((((PIS.VLRTOT-PIS.VLRDESC))*V_REDBASEPIS),2)*V_TRIBUTA, ALIQUOTA = V_ALIQPIS, CST = V_CSTPIS, VALOR = ROUND((((((PIS.VLRTOT-PIS.VLRDESC))*V_REDBASEPIS)*V_ALIQPIS)/100),2)
WHERE NUNICO = PIS.NUNICO
AND SEQ = PIS.SEQ
AND SEQUENCIA = PIS.SEQUENCIA
AND CODPROD = PIS.CODPROD
AND NUNOTA = PIS.NUNOTA
AND CODIMP = 6;



END IF;


END LOOP;


--VALIDA REGRAS COFINS
--Prioridade 1 das Alíquotas -TOP, Empresa e grupo.

FOR COFINS IN (
SELECT
I.CODPARC,
I.CODTIPOPER,
I.GRUPOPIS,
I.GRUPOCOFINS,
I.SEQUENCIA,
I.CODPROD,
I.NUNOTA,
I.CODINC,
I.CODIMP,
I.VLRTOT,
I.VLRICMS,
NVL(I.VLRDESC,0) AS VLRDESC,
I.BASE, 
I.BASERED,
I.ALIQUOTA,
I.CST,
I.VALOR,
A.CODEMP,
I.NUNICO,
I.SEQ,
CASE WHEN 
I.CODCFO <5000 THEN 'E'
WHEN I.CODCFO>5000 THEN 'S'
END AS ENTSAI



FROM AD_ITEAPURACAOEFD I, AD_APURACAOEFD A
WHERE I.NUNICO = A.NUNICO
AND A.SEQ = I.SEQ
AND I.NUNICO = FIELD_NUNICO
AND I.SEQ IN FIELD_SEQ
AND I.SEQUENCIA IN FIELD_SEQUENCIA
AND I.CODIMP = 7 )LOOP


SELECT 
NVL(COUNT(*),0)
INTO V_EMPCOFINS

FROM TGFIFE
WHERE NOMEIMP = 'COFINS'
AND CODTIPOPER = COFINS.CODTIPOPER
AND GRUPOIMP = COFINS.GRUPOPIS
AND CODEMP = COFINS.CODEMP
AND ENTSAI = COFINS.ENTSAI
AND CODPARC = 0;


IF V_EMPCOFINS >=1 THEN


SELECT 
CASE WHEN REDBASE = 0 THEN 1
ELSE REDBASE/100 END AS REDBASE,

nvl(ALIQ,0), 
nvl(CST,0),
CASE WHEN ALIQ = 0 THEN 0
ELSE 1 END AS TRIBUTA
INTO V_PREDBASECOFINSEMP,
V_ALIQCOFINSEMP,
V_CSTCOFINSEMP,
V_TRIBUTACOFINSEMP


FROM TGFIFE
WHERE NOMEIMP = 'COFINS'
AND CODTIPOPER = COFINS.CODTIPOPER
AND CODEMP = COFINS.CODEMP
AND GRUPOIMP = COFINS.GRUPOPIS
AND ENTSAI = COFINS.ENTSAI
AND CODPARC = 0;

UPDATE AD_ITEAPURACAOEFD SET ALTERADO =1, BASE = ROUND((COFINS.VLRTOT-COFINS.VLRDESC),2)*V_TRIBUTACOFINSEMP, BASERED = ROUND((((COFINS.VLRTOT-COFINS.VLRDESC))*V_PREDBASECOFINSEMP),2)*V_TRIBUTACOFINSEMP, ALIQUOTA = V_ALIQCOFINSEMP, CST = V_CSTCOFINSEMP, VALOR = ROUND((((((COFINS.VLRTOT-COFINS.VLRDESC))*V_PREDBASECOFINSEMP)*V_ALIQCOFINSEMP)/100),2) 
WHERE NUNICO = COFINS.NUNICO
AND SEQ = COFINS.SEQ
AND SEQUENCIA = COFINS.SEQUENCIA
AND CODPROD = COFINS.CODPROD
AND NUNOTA = COFINS.NUNOTA
AND CODIMP = 7;


END IF;

--PRIORIDADE 2 TOP, GRUPO
IF V_EMPCOFINS <=0 THEN 


SELECT 
NVL(COUNT(*),0)
INTO V_TOPCOFINS

FROM TGFIFE
WHERE NOMEIMP = 'COFINS'
AND CODTIPOPER = COFINS.CODTIPOPER
AND GRUPOIMP = COFINS.GRUPOPIS
AND CODEMP = 0
AND ENTSAI = COFINS.ENTSAI
AND CODPARC = 0;

IF V_TOPCOFINS >=1 THEN 

SELECT 
CASE WHEN REDBASE = 0 THEN 1
ELSE REDBASE/100 END AS REDBASE,
nvl(ALIQ,0), 
nvl(CST,0),
CASE WHEN ALIQ = 0 THEN 0
ELSE 1 END AS TRIBUTA
INTO V_REDBASECOFINS,
V_ALIQCOFINS,
V_CSTCOFINS,
V_TRIBUTA



FROM TGFIFE
WHERE NOMEIMP = 'COFINS'
AND CODTIPOPER = COFINS.CODTIPOPER
AND GRUPOIMP = COFINS.GRUPOPIS
AND ENTSAI = COFINS.ENTSAI
AND CODPARC =0
AND CODEMP = 0;




UPDATE AD_ITEAPURACAOEFD SET ALTERADO =1, BASE = ROUND((COFINS.VLRTOT-COFINS.VLRDESC),2)*V_TRIBUTA, BASERED = ROUND((((COFINS.VLRTOT-COFINS.VLRDESC))*V_REDBASECOFINS),2)*V_TRIBUTA, ALIQUOTA = V_ALIQCOFINS, CST = V_CSTCOFINS, VALOR = ROUND((((((COFINS.VLRTOT-COFINS.VLRDESC))*V_REDBASECOFINS)*V_ALIQCOFINS)/100),2)
WHERE NUNICO = COFINS.NUNICO
AND SEQ = COFINS.SEQ
AND SEQUENCIA = COFINS.SEQUENCIA
AND CODPROD = COFINS.CODPROD
AND NUNOTA = COFINS.NUNOTA
AND CODIMP = 7;

END IF;
END IF;

--Prioridade 3 das Alíquotas - GRUPO.
IF V_EMPCOFINS <=0 AND V_TOPCOFINS <=0 THEN 

SELECT 
CASE WHEN REDBASE = 0 THEN 1
ELSE REDBASE/100 END AS REDBASE,
nvl(ALIQ,0), 
nvl(CST,0),
CASE WHEN ALIQ = 0 THEN 0
ELSE 1 END AS TRIBUTA
INTO V_REDBASECOFINS,
V_ALIQCOFINS,
V_CSTCOFINS,
V_TRIBUTA



FROM TGFIFE
WHERE NOMEIMP = 'COFINS'
AND CODTIPOPER = 0
AND GRUPOIMP = COFINS.GRUPOPIS
AND ENTSAI = COFINS.ENTSAI
AND CODPARC =0
AND CODEMP = 0;


UPDATE AD_ITEAPURACAOEFD SET ALTERADO =1, BASE = ROUND((COFINS.VLRTOT-COFINS.VLRDESC),2)*V_TRIBUTA, BASERED = ROUND((((COFINS.VLRTOT-COFINS.VLRDESC))*V_REDBASECOFINS),2)*V_TRIBUTA, ALIQUOTA = V_ALIQCOFINS, CST = V_CSTCOFINS, VALOR = ROUND((((((COFINS.VLRTOT-COFINS.VLRDESC))*V_REDBASECOFINS)*V_ALIQCOFINS)/100),2)
WHERE NUNICO = COFINS.NUNICO
AND SEQ = COFINS.SEQ
AND SEQUENCIA = COFINS.SEQUENCIA
AND CODPROD = COFINS.CODPROD
AND NUNOTA = COFINS.NUNOTA
AND CODIMP = 7;


END IF; 

END LOOP;
  END LOOP;



--INICIO DA ATUALIZAÇÃO DOS TOTALIZADORES
DELETE FROM AD_CONAPURACAOEFD WHERE NUNICO = V_NUNICO AND SEQ = V_SEQ;

FOR CONS IN (select CODCFO,CODINC,CST,BASEPIS,BASEREDPIS,VALORPIS,BASECOFINS,BASEREDCOFINS,VALORCOFINS,SEQ ,NUNICO,CODEMP,SEQUENCIA from(
select 
EFD.CODCFO,
EFD.NUNICO,
APR.CODEMP,
EFD.CODINC,
EFD.CST,
EFD.SEQ,
(SELECT sum(BASE) FROM AD_ITEAPURACAOEFD A WHERE A.NUNICO = EFD.NUNICO AND A.CODIMP = 6 AND A.CODCFO = EFD.CODCFO AND A.CODINC = EFD.CODINC AND A.CST = EFD.CST AND A.SEQ = EFD.SEQ ) AS BASEPIS,
(SELECT sum(BASERED) FROM AD_ITEAPURACAOEFD A WHERE A.NUNICO = EFD.NUNICO AND A.CODIMP = 6 AND A.CODCFO = EFD.CODCFO AND A.CODINC = EFD.CODINC AND A.CST = EFD.CST AND A.SEQ = EFD.SEQ ) AS BASEREDPIS,
(SELECT sum(VALOR) FROM AD_ITEAPURACAOEFD A WHERE A.NUNICO = EFD.NUNICO AND A.CODIMP = 6 AND A.CODCFO = EFD.CODCFO AND A.CODINC = EFD.CODINC AND A.CST = EFD.CST AND A.SEQ = EFD.SEQ ) AS VALORPIS, 
(SELECT sum(BASE) FROM AD_ITEAPURACAOEFD A WHERE A.NUNICO = EFD.NUNICO AND A.CODIMP = 7 AND A.CODCFO = EFD.CODCFO AND A.CODINC = EFD.CODINC AND A.CST = EFD.CST AND A.SEQ = EFD.SEQ) AS BASECOFINS,
(SELECT sum(BASERED) FROM AD_ITEAPURACAOEFD A WHERE A.NUNICO = EFD.NUNICO AND A.CODIMP = 7 AND A.CODCFO = EFD.CODCFO AND A.CODINC = EFD.CODINC AND A.CST = EFD.CST AND A.SEQ = EFD.SEQ ) AS BASEREDCOFINS,
(SELECT sum(VALOR) FROM AD_ITEAPURACAOEFD A WHERE A.NUNICO = EFD.NUNICO AND A.CODIMP = 7 AND A.CODCFO = EFD.CODCFO AND A.CODINC = EFD.CODINC AND A.CST = EFD.CST AND A.SEQ = EFD.SEQ ) AS VALORCOFINS,
rank() over (order by CODCFO, CST,CODINC,EFD.SEQ, EFD.CST) SEQUENCIA





from AD_ITEAPURACAOEFD EFD, AD_APURACAOEFD APR
WHERE APR.NUNICO = V_NUNICO
AND EFD.SEQ = APR.SEQ
and apr.nunico = efd.nunico
AND APR.SEQ = V_SEQ
group by 
EFD.CODCFO,
EFD.CODINC,
EFD.nunico,
EFD.SEQ,
EFD.CST, APR.CODEMP)WHERE VALORPIS >0 OR VALORCOFINS>0)LOOP



insert into AD_CONAPURACAOEFD
(SEQ,
NUNICO, 
SEQUENCIA,
CODEMP,
CODCFO,
CST,
BASEPIS,
BASEREDPIS,
VALORPIS, 
BASECOFINS, 
BASEREDCOFINS, 
VALORCOFINS)values (CONS.SEQ,
CONS.NUNICO, 
CONS.SEQUENCIA,
CONS.CODEMP,
CONS.CODCFO,
CONS.CST,
CONS.BASEPIS, 
CONS.BASEREDPIS, 
CONS.VALORPIS, 
CONS.BASECOFINS, 
CONS.BASEREDCOFINS, 
CONS.VALORCOFINS);


END LOOP;






DELETE FROM AD_CONAPURACAOEFDEMP WHERE NUNICO = FIELD_NUNICO;
FOR CONS_EMPRESA IN (SELECT * FROM (select 
CODEMP,
CODCFO, 
NUNICO,
SUM(BASEREDPIS) BASEREDPIS,
SUM(BASEREDCOFINS) BASEREDCOFINS,
SUM(BASEPIS) BASEPIS,
SUM(BASECOFINS) BASECOFINS,
SUM(VALORPIS) VALORPIS,
SUM(VALORCOFINS) VALORCOFINS,
rank() over (order by CODCFO,CODEMP) SEQUENCIA

from AD_CONAPURACAOEFD
WHERE NUNICO = FIELD_NUNICO
GROUP BY 
CODEMP,
CODCFO,
NUNICO)WHERE VALORPIS >0 OR VALORCOFINS >0)
LOOP

insert into AD_CONAPURACAOEFDEMP
(SEQUENCIA,
NUNICO, 
CODEMP,
CODCFO,
BASEPIS,
BASEREDPIS,
VALORPIS, 
BASECOFINS, 
BASEREDCOFINS, 
VALORCOFINS)values (CONS_EMPRESA.SEQUENCIA,
CONS_EMPRESA.NUNICO, 
CONS_EMPRESA.CODEMP,
CONS_EMPRESA.CODCFO,
CONS_EMPRESA.BASEPIS, 
CONS_EMPRESA.BASEREDPIS, 
CONS_EMPRESA.VALORPIS, 
CONS_EMPRESA.BASECOFINS, 
CONS_EMPRESA.BASEREDCOFINS, 
CONS_EMPRESA.VALORCOFINS);

END LOOP;

DELETE FROM AD_CONAPURACAOEFDMATRIZ WHERE NUNICO = FIELD_NUNICO;
FOR CONS_GERAL IN (SELECT * FROM (select 
CODCFO, 
NUNICO,
SUM(BASEREDPIS) BASEREDPIS,
SUM(BASEREDCOFINS) BASEREDCOFINS,
SUM(BASEPIS) BASEPIS,
SUM(BASECOFINS) BASECOFINS,
SUM(VALORPIS) VALORPIS,
SUM(VALORCOFINS) VALORCOFINS,
rank() over (order by CODCFO) SEQUENCIA

from AD_CONAPURACAOEFD
WHERE NUNICO = FIELD_NUNICO
GROUP BY 
CODCFO,
NUNICO)WHERE VALORPIS >0 OR VALORCOFINS >0) LOOP

insert into AD_CONAPURACAOEFDMATRIZ
(SEQUENCIA,
NUNICO, 
CODCFO,
BASEPIS,
BASEREDPIS,
VALORPIS, 
BASECOFINS, 
BASEREDCOFINS, 
VALORCOFINS)values (CONS_GERAL.SEQUENCIA,
CONS_GERAL.NUNICO, 
CONS_GERAL.CODCFO,
CONS_GERAL.BASEPIS, 
CONS_GERAL.BASEREDPIS, 
CONS_GERAL.VALORPIS, 
CONS_GERAL.BASECOFINS, 
CONS_GERAL.BASEREDCOFINS, 
CONS_GERAL.VALORCOFINS);





END LOOP;



 P_MENSAGEM := 'Alteração realizada com sucesso !!';




END;
/
